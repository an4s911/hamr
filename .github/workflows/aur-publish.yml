name: Publish to AUR

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH key
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat > ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config
          
      - name: Debug SSH key
        run: |
          echo "Key file exists:"
          ls -la ~/.ssh/aur
          echo "Key fingerprint:"
          ssh-keygen -lf ~/.ssh/aur
          echo "Testing connection:"
          ssh -vT aur@aur.archlinux.org || true

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update PKGBUILD version
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

      - name: Publish to AUR
        run: |
          git clone ssh://aur@aur.archlinux.org/hamr.git aur-repo
          cd aur-repo
          git config user.email "siwei.wong@gmail.com"
          git config user.name "Stewart Wong"
          cp ../PKGBUILD ../hamr.install .
          
          # Generate .SRCINFO manually (no makepkg on ubuntu)
          cat > .SRCINFO << 'SRCINFO'
          pkgbase = hamr
          	pkgdesc = Extensible launcher for Hyprland built with Quickshell
          	pkgver = ${{ steps.version.outputs.version }}
          	pkgrel = 1
          	url = https://github.com/Stewart86/hamr
          	arch = any
          	license = GPL-3.0-or-later
          	depends = quickshell
          	depends = qt6-5compat
          	depends = python
          	depends = python-click
          	depends = python-loguru
          	depends = python-tqdm
          	depends = python-gobject
          	depends = gnome-desktop-4
          	depends = wl-clipboard
          	depends = cliphist
          	depends = fd
          	depends = fzf
          	depends = xdg-utils
          	depends = libnotify
          	depends = gtk3
          	depends = hyprland
          	depends = libpulse
          	depends = jq
          	depends = libqalculate
          	depends = ttf-material-symbols-variable
          	depends = ttf-jetbrains-mono-nerd
          	optdepends = ttf-readex-pro: Reading font for cards (AUR)
          	optdepends = tesseract: OCR text extraction for screenshot search
          	optdepends = tesseract-data-eng: English OCR language data
          	optdepends = imagemagick: Alternative thumbnail generation
          	optdepends = bitwarden-cli: Bitwarden password manager integration
          	optdepends = slurp: Screen region selection for screenshots
          	optdepends = wf-recorder: Screen recording
          	install = hamr.install
          	source = git+https://github.com/Stewart86/hamr.git
          	sha256sums = SKIP

          pkgname = hamr
          SRCINFO
          
          # Fix version in .SRCINFO
          sed -i "s/pkgver = .*/pkgver = ${{ steps.version.outputs.version }}/" .SRCINFO
          
          git add PKGBUILD .SRCINFO hamr.install
          git commit -m "Update to ${{ steps.version.outputs.version }}"
          git push
