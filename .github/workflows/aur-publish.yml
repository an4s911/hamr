name: Publish to AUR

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install SSH key
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat > ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config
          
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update PKGBUILD version
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

      - name: Publish to AUR
        run: |
          git clone ssh://aur@aur.archlinux.org/hamr.git aur-repo
          cd aur-repo
          git config user.email "siwei.wong@gmail.com"
          git config user.name "Stewart Wong"
          cp ../PKGBUILD ../hamr.install .
          
          # Generate .SRCINFO manually (no makepkg on ubuntu)
          cat > .SRCINFO << 'SRCINFO'
          pkgbase = hamr
          	pkgdesc = Extensible launcher for Hyprland built with Quickshell
          	pkgver = ${{ steps.version.outputs.version }}
          	pkgrel = 1
          	url = https://github.com/Stewart86/hamr
          	arch = any
          	license = GPL-3.0-or-later
          	depends = quickshell
          	depends = qt6-5compat
          	depends = python
          	depends = python-click
          	depends = python-loguru
          	depends = python-tqdm
          	depends = python-gobject
          	depends = gnome-desktop-4
          	depends = wl-clipboard
          	depends = cliphist
          	depends = fd
          	depends = fzf
          	depends = xdg-utils
          	depends = libnotify
          	depends = gtk3
          	depends = hyprland
          	depends = libpulse
          	depends = jq
          	depends = libqalculate
          	depends = ttf-material-symbols-variable
          	depends = ttf-jetbrains-mono-nerd
          	optdepends = ttf-readex-pro: Reading font for cards (AUR)
          	optdepends = tesseract: OCR text extraction for screenshot search
          	optdepends = tesseract-data-eng: English OCR language data
          	optdepends = imagemagick: Alternative thumbnail generation
          	optdepends = bitwarden-cli: Bitwarden password manager integration
          	optdepends = slurp: Screen region selection for screenshots
          	optdepends = wf-recorder: Screen recording
          	install = hamr.install
          	source = git+https://github.com/Stewart86/hamr.git
          	sha256sums = SKIP

          pkgname = hamr
          SRCINFO
          
          # Fix version in .SRCINFO
          sed -i "s/pkgver = .*/pkgver = ${{ steps.version.outputs.version }}/" .SRCINFO
          
          git add PKGBUILD .SRCINFO hamr.install
          git diff --cached --quiet || git commit -m "Update to ${{ steps.version.outputs.version }}"
          git push || true

      - name: Generate release notes
        id: release_notes
        run: |
          # Get current tag from ref
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          
          # Get previous tag (excluding current)
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -1)
          
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" ${PREV_TAG}..${CURRENT_TAG} --no-merges)
          else
            COMMITS=$(git log --pretty=format:"%s" --no-merges -20)
          fi
          
          # Sort by conventional commit type
          FEAT=$(echo "$COMMITS" | grep -E "^feat(\(.+\))?:" | sed 's/^/- /' || true)
          FIX=$(echo "$COMMITS" | grep -E "^fix(\(.+\))?:" | sed 's/^/- /' || true)
          PERF=$(echo "$COMMITS" | grep -E "^perf(\(.+\))?:" | sed 's/^/- /' || true)
          REFACTOR=$(echo "$COMMITS" | grep -E "^refactor(\(.+\))?:" | sed 's/^/- /' || true)
          DOCS=$(echo "$COMMITS" | grep -E "^docs(\(.+\))?:" | sed 's/^/- /' || true)
          CHORE=$(echo "$COMMITS" | grep -E "^chore(\(.+\))?:" | sed 's/^/- /' || true)
          CI=$(echo "$COMMITS" | grep -E "^ci(\(.+\))?:" | sed 's/^/- /' || true)
          TEST=$(echo "$COMMITS" | grep -E "^test(\(.+\))?:" | sed 's/^/- /' || true)
          OTHER=$(echo "$COMMITS" | grep -vE "^(feat|fix|perf|refactor|docs|chore|ci|test)(\(.+\))?:" | sed 's/^/- /' || true)
          
          # Build release notes
          NOTES=""
          [ -n "$FEAT" ] && NOTES="${NOTES}### Features\n${FEAT}\n\n"
          [ -n "$FIX" ] && NOTES="${NOTES}### Bug Fixes\n${FIX}\n\n"
          [ -n "$PERF" ] && NOTES="${NOTES}### Performance\n${PERF}\n\n"
          [ -n "$REFACTOR" ] && NOTES="${NOTES}### Refactoring\n${REFACTOR}\n\n"
          [ -n "$DOCS" ] && NOTES="${NOTES}### Documentation\n${DOCS}\n\n"
          [ -n "$TEST" ] && NOTES="${NOTES}### Tests\n${TEST}\n\n"
          [ -n "$CI" ] && NOTES="${NOTES}### CI/CD\n${CI}\n\n"
          [ -n "$CHORE" ] && NOTES="${NOTES}### Chores\n${CHORE}\n\n"
          [ -n "$OTHER" ] && NOTES="${NOTES}### Other\n${OTHER}\n\n"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body: |
            ${{ steps.release_notes.outputs.notes }}
            ## Installation
            ```bash
            paru -S hamr
            ```
          generate_release_notes: false
